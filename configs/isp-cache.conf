# ISP SaaS Platform - Nginx Caching Proxy Configuration
# Place this file in /etc/nginx/sites-available/ and symlink to sites-enabled

# Custom log format with cache status for proper telemetry collection
log_format cache_log '$remote_addr - $remote_user [$time_local] '
                     '"$request" $status $body_bytes_sent '
                     '"$http_referer" "$http_user_agent" '
                     'cache=$upstream_cache_status rt=$request_time';

# Cache storage configuration - adjust max_size based on available disk
proxy_cache_path /var/cache/nginx/isp-cache 
    levels=1:2 
    keys_zone=isp_cache:500m 
    max_size=50g 
    inactive=30d 
    use_temp_path=off;

# Rate limiting for DoS protection
limit_req_zone $binary_remote_addr zone=cache_limit:10m rate=100r/s;

# Main caching proxy server
server {
    listen 80 default_server;
    server_name _;
    
    # DNS resolver - use your upstream DNS
    resolver 8.8.8.8 8.8.4.4 1.1.1.1 valid=300s ipv6=off;
    resolver_timeout 30s;
    
    # Access log with cache status for telemetry
    access_log /var/log/nginx/cache.log cache_log;
    error_log /var/log/nginx/cache-error.log;
    
    # Rate limiting
    limit_req zone=cache_limit burst=200 nodelay;
    
    location / {
        # Cache configuration
        proxy_cache isp_cache;
        proxy_cache_key "$scheme$request_method$host$request_uri";
        
        # Cache valid responses
        proxy_cache_valid 200 206 30d;
        proxy_cache_valid 301 302 1h;
        proxy_cache_valid 404 1m;
        proxy_cache_valid any 1m;
        
        # Use stale content on errors
        proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
        proxy_cache_background_update on;
        proxy_cache_lock on;
        proxy_cache_lock_timeout 5s;
        
        # Allow byte-range requests for large file downloads
        proxy_cache_revalidate on;
        slice 1m;
        proxy_cache_key "$scheme$request_method$host$uri$is_args$args$slice_range";
        proxy_set_header Range $slice_range;
        
        # Forward request to origin
        proxy_pass http://$host$request_uri;
        proxy_http_version 1.1;
        
        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Connection "";
        
        # Add cache status header for debugging
        add_header X-Cache-Status $upstream_cache_status always;
        add_header X-Served-By "ISP-Cache" always;
        
        # Timeouts for large downloads
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        
        # Buffer sizes for large files
        proxy_buffers 32 4m;
        proxy_buffer_size 1m;
        proxy_busy_buffers_size 8m;
        proxy_max_temp_file_size 8192m;
        
        # Don't cache requests with cookies or authorization
        proxy_cache_bypass $http_authorization;
        proxy_no_cache $http_authorization;
    }
    
    # Health check endpoint for monitoring
    location /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }
    
    # Cache stats endpoint (restricted to localhost)
    location /cache-status {
        allow 127.0.0.1;
        allow ::1;
        deny all;
        
        default_type text/plain;
        return 200 "Cache Active\n";
    }
}

# Gaming CDN specific server blocks for optimal caching
# Steam Content Delivery
server {
    listen 80;
    server_name steamcontent.com *.steamcontent.com 
                client-download.steampowered.com cdn.steampowered.com 
                cdn.steamstatic.com *.steampowered.com;
    
    resolver 8.8.8.8 8.8.4.4 valid=300s ipv6=off;
    access_log /var/log/nginx/cache.log cache_log;
    
    location / {
        proxy_cache isp_cache;
        proxy_cache_key "$host$request_uri";
        proxy_cache_valid 200 206 365d;  # Cache Steam content for 1 year
        proxy_cache_valid any 1m;
        
        proxy_cache_use_stale error timeout http_500 http_502 http_503;
        proxy_cache_lock on;
        
        # Slice for large Steam downloads
        slice 8m;
        proxy_cache_key "$host$uri$is_args$args$slice_range";
        proxy_set_header Range $slice_range;
        
        proxy_pass http://$host$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        
        add_header X-Cache-Status $upstream_cache_status always;
        
        proxy_connect_timeout 60s;
        proxy_read_timeout 600s;  # 10 min for large downloads
    }
}

# Epic Games Store
server {
    listen 80;
    server_name download.epicgames.com *.epicgames.com epicgames-download1.akamaized.net;
    
    resolver 8.8.8.8 8.8.4.4 valid=300s ipv6=off;
    access_log /var/log/nginx/cache.log cache_log;
    
    location / {
        proxy_cache isp_cache;
        proxy_cache_key "$host$request_uri";
        proxy_cache_valid 200 206 365d;
        proxy_cache_valid any 1m;
        
        proxy_cache_use_stale error timeout;
        proxy_cache_lock on;
        
        slice 8m;
        proxy_cache_key "$host$uri$is_args$args$slice_range";
        proxy_set_header Range $slice_range;
        
        proxy_pass http://$host$request_uri;
        proxy_set_header Host $host;
        
        add_header X-Cache-Status $upstream_cache_status always;
        
        proxy_read_timeout 600s;
    }
}

# Battle.net (Blizzard)
server {
    listen 80;
    server_name dist.blizzard.com *.blizzard.com blzddist1-a.akamaihd.net;
    
    resolver 8.8.8.8 8.8.4.4 valid=300s ipv6=off;
    access_log /var/log/nginx/cache.log cache_log;
    
    location / {
        proxy_cache isp_cache;
        proxy_cache_key "$host$request_uri";
        proxy_cache_valid 200 206 365d;
        proxy_cache_valid any 1m;
        
        proxy_cache_use_stale error timeout;
        proxy_cache_lock on;
        
        slice 8m;
        proxy_cache_key "$host$uri$is_args$args$slice_range";
        proxy_set_header Range $slice_range;
        
        proxy_pass http://$host$request_uri;
        proxy_set_header Host $host;
        
        add_header X-Cache-Status $upstream_cache_status always;
        
        proxy_read_timeout 600s;
    }
}

